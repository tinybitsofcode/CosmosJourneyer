/*
 *  This file is part of Cosmos Journeyer
 *
 *  Copyright (C) 2024 Barthélemy Paléologue <barth.paleologue@cosmosjourneyer.com>
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Affero General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Affero General Public License for more details.
 *
 *  You should have received a copy of the GNU Affero General Public License
 *  along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

"use strict";(globalThis.webpackChunkcosmos_journeyer=globalThis.webpackChunkcosmos_journeyer||[]).push([["263"],{7521:function(e,t,r){let n;r.r(t),r.d(t,{Dispose:()=>c,DumpData:()=>f,DumpDataAsync:()=>d,DumpFramebuffer:()=>p,DumpTools:()=>y});var a=r(79268),i=r(60892),l=r(68645),o=r(66395);let s=null;async function u(){return s||(s=new Promise((e,t)=>{let i,l=null,s={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};Promise.resolve().then(r.bind(r,81171)).then(({ThinEngine:u})=>{let p=o.l.Instances.length;try{i=new OffscreenCanvas(100,100),l=new u(i,!1,s)}catch(e){p<o.l.Instances.length&&o.l.Instances.pop()?.dispose(),l=new u(i=document.createElement("canvas"),!1,s)}o.l.Instances.pop(),o.l.OnEnginesDisposedObservable.add(e=>{l&&e!==l&&!l.isDisposed&&0===o.l.Instances.length&&c()}),l.getCaps().parallelShaderCompile=void 0;let d=new a.I(l);r.e("5970").then(r.bind(r,80364)).then(({passPixelShader:r})=>{if(!l)return void t("Engine is not defined");let o=new a.H({engine:l,name:r.name,fragmentShader:r.shader,samplerNames:["textureSampler"]});e(n={canvas:i,engine:l,renderer:d,wrapper:o})})}).catch(t)})),await s}async function p(e,t,r,n,a="image/png",i,l){let o=new Uint8Array((await r.readPixels(0,0,e,t)).buffer);f(e,t,o,n,a,i,!0,void 0,l)}function d(e,t,r,n="image/png",a,i=!1,l=!1,o){return new Promise(s=>{f(e,t,r,e=>s(e),n,a,i,l,o)})}function f(e,t,r,n,a="image/png",o,s=!1,p=!1,d){u().then(u=>{if(u.engine.setSize(e,t,!0),r instanceof Float32Array){let e=new Uint8Array(r.length),t=r.length;for(;t--;){let n=r[t];e[t]=Math.round(255*(0,l.Clamp)(n))}r=e}let f=u.engine.createRawTexture(r,e,t,5,!1,!s,1);u.renderer.setViewport(),u.renderer.applyEffectWrapper(u.wrapper),u.wrapper.effect._bindTexture("textureSampler",f),u.renderer.draw(),p?i.w1.ToBlob(u.canvas,e=>{let t=new FileReader;t.onload=e=>{let t=e.target.result;n&&n(t)},t.readAsArrayBuffer(e)},a,d):i.w1.EncodeScreenshotCanvasData(u.canvas,n,a,o,d),f.dispose()})}function c(){n?(n.wrapper.dispose(),n.renderer.dispose(),n.engine.dispose()):s?.then(e=>{e.wrapper.dispose(),e.renderer.dispose(),e.engine.dispose()}),s=null,n=null}let y={DumpData:f,DumpDataAsync:d,DumpFramebuffer:p,Dispose:c};i.w1.DumpData=f,i.w1.DumpDataAsync=d,i.w1.DumpFramebuffer=p},4592:function(e,t,r){r.d(t,{D0:()=>v,En:()=>T,Lf:()=>D,QH:()=>h,Ro:()=>_,hO:()=>b,oJ:()=>A,p6:()=>m,qC:()=>M,qJ:()=>x,qh:()=>P});var n=r(60892),a=r(51971),i=r(68645),l=r(74262),o=r(10967),s=r(41583),u=r(3895),p=r(88970),d=r(92550),f=r(52386),c=r(7521);r(24229);let y="image/png",g=[134,22,135,150,246,214,150,54];function x(e){let t=new DataView(e.buffer,e.byteOffset,e.byteLength),r=0;for(let e=0;e<g.length;e++)if(t.getUint8(r++)!==g[e])return d.Y.Error("Not a babylon environment map"),null;let n="",a=0;for(;a=t.getUint8(r++);)n+=String.fromCharCode(a);let i=JSON.parse(n);return(i=h(i)).binaryDataPosition=r,i.specular&&(i.specular.lodGenerationScale=i.specular.lodGenerationScale||.8),i}function h(e){if(e.version>2)throw Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "2".`);return 2===e.version?e:e={...e,version:2,imageType:y}}async function m(e,t={}){let r=e.getInternalTexture();if(!r)return Promise.reject("The cube texture is invalid.");let n=r.getEngine();if(2!==e.textureType&&1!==e.textureType&&0!==e.textureType&&0!==e.textureType&&7!==e.textureType&&-1!==e.textureType)return Promise.reject("The cube texture should allow HDR (Full Float or Half Float).");let a=1;if(!n.getCaps().textureFloatRender&&(a=2,!n.getCaps().textureHalfFloatRender))return Promise.reject("Env texture can only be created when the browser supports half float or full float rendering.");e.sphericalPolynomial;let l=e.getInternalTexture()?._sphericalPolynomialPromise,o=r.width,s=new u.x(n),p={},d={};n.flushFramebuffer();let f=t.imageType??y,c=(0,i.ILog2)(r.width);for(let r=0;r<=c;r++){let n=Math.pow(2,c-r);for(let i=0;i<6;i++)p[6*r+i]=await w(s,e,a,i,r,n,f,t.imageQuality)}let x=t.disableIrradianceTexture?null:e.irradianceTexture;if(x){let e=x.getSize().width;for(let r=0;r<6;r++)d[r]=await w(s,x,a,r,0,e,f,t.imageQuality)}s.dispose(),l&&await l;let h={version:2,width:o,imageType:f,irradiance:function(e){let t=e.sphericalPolynomial;return null==t?null:{x:[t.x.x,t.x.y,t.x.z],y:[t.y.x,t.y.y,t.y.z],z:[t.z.x,t.z.y,t.z.z],xx:[t.xx.x,t.xx.y,t.xx.z],yy:[t.yy.x,t.yy.y,t.yy.z],zz:[t.zz.x,t.zz.y,t.zz.z],yz:[t.yz.x,t.yz.y,t.yz.z],zx:[t.zx.x,t.zx.y,t.zx.z],xy:[t.xy.x,t.xy.y,t.xy.z]}}(e),specular:{mipmaps:[],lodGenerationScale:e.lodGenerationScale}},T=0;for(let e=0;e<=c;e++)for(let t=0;t<6;t++){let r=p[6*e+t].byteLength;h.specular.mipmaps.push({length:r,position:T}),T+=r}if(x){h.irradiance=h.irradiance||{x:[0,0,0],xx:[0,0,0],y:[0,0,0],yy:[0,0,0],z:[0,0,0],zz:[0,0,0],yz:[0,0,0],zx:[0,0,0],xy:[0,0,0]},h.irradiance.irradianceTexture={size:x.getSize().width,faces:[]};for(let e=0;e<6;e++){let t=d[e].byteLength;h.irradiance.irradianceTexture.faces.push({length:t,position:T}),T+=t}}let b=JSON.stringify(h),_=new ArrayBuffer(b.length+1),z=new Uint8Array(_);for(let e=0,t=b.length;e<t;e++)z[e]=b.charCodeAt(e);z[b.length]=0;let A=new ArrayBuffer(g.length+T+_.byteLength),v=new Uint8Array(A),R=new DataView(A),M=0;for(let e=0;e<g.length;e++)R.setUint8(M++,g[e]);v.set(new Uint8Array(_),M),M+=_.byteLength;for(let e=0;e<=c;e++)for(let t=0;t<6;t++){let r=p[6*e+t];v.set(new Uint8Array(r),M),M+=r.byteLength}if(x)for(let e=0;e<6;e++){let t=d[e];v.set(new Uint8Array(t),M),M+=t.byteLength}return A}async function w(e,t,r,n,a,i,l,o){let s=await t.readPixels(n,a,void 0,!1);if(s&&s.byteLength===s.length){let e=new Float32Array(4*s.byteLength);for(let t=0;t<s.byteLength;t++)e[t]=s[t]/255,e[t]=Math.pow(e[t],2.2);s=e}else if(s&&t.gammaSpace){let e=s;for(let t=0;t<e.length;t++)e[t]=Math.pow(e[t],2.2)}let u=e.getEngine(),p=u.createRawTexture(s,i,i,5,!1,!0,1,null,r);await f.r.EncodeTextureToRGBD(p,e,r);let d=await u._readTexturePixels(p,i,i),y=await (0,c.DumpDataAsync)(i,i,d,l,void 0,!1,!0,o);return p.dispose(),y}function T(e,t){let r=(t=h(t)).specular,n=Math.log2(t.width);if(n=Math.round(n)+1,r.mipmaps.length!==6*n)throw Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);let a=Array(n);for(let i=0;i<n;i++){a[i]=Array(6);for(let n=0;n<6;n++){let l=r.mipmaps[6*i+n];a[i][n]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+l.position,l.length)}}return a}function b(e,t){t=h(t);let r=Array(6),n=t.irradiance?.irradianceTexture;if(n){if(6!==n.faces.length)throw Error(`Incorrect irradiance texture faces number "${n.faces.length}"`);for(let a=0;a<6;a++){let i=n.faces[a];r[a]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+i.position,i.length)}}return r}function _(e,t,r){let n=(r=h(r)).specular;if(!n)return Promise.resolve([]);e._lodGenerationScale=n.lodGenerationScale;let a=[],i=T(t,r);a.push(A(e,i,r.imageType));let l=r.irradiance?.irradianceTexture;if(l){let n=b(t,r);a.push(v(e,n,l.size,r.imageType))}return Promise.all(a)}function z(e,t,r,n,a,i,l,o,s,u,p){return new Promise((d,f)=>{if(r){let r=t.createTexture(null,!0,!0,null,1,null,e=>{f(e)},e);n?.onEffectCreatedObservable.addOnce(o=>{o.executeWhenCompiled(()=>{n.externalTextureSamplerBinding=!0,n.onApply=n=>{n._bindTexture("textureSampler",r),n.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([n],u,!0,i,l),t.restoreDefaultFramebuffer(),r.dispose(),URL.revokeObjectURL(a),d())})})}else{if(t._uploadImageToTexture(p,e,i,l),o){let r=s[l];r&&t._uploadImageToTexture(r._texture,e,i,0)}d()}})}async function A(e,t,r=y){let n=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,e),await R(e,t,!0,r),e.isReady=!0}async function v(e,t,r,n=y){let a=e.getEngine(),i=new o.l(a,5);e._irradianceTexture=new s.V(a,i),i.isCube=!0,i.format=5,i.type=0,i.generateMipMaps=!0,i._cachedAnisotropicFilteringLevel=null,i.generateMipMaps=!0,i.width=r,i.height=r,a.updateTextureSamplingMode(3,i),await R(i,[t],!1,n),a.generateMipMapsForCubemap(i),i.isReady=!0}async function R(e,t,a,l=y){if(!n.w1.IsExponentOfTwo(e.width))throw Error("Texture size must be a power of two");let u=(0,i.ILog2)(e.width)+1,d=e.getEngine(),f=!1,c=!1,g=null,x=null,h=null,m=d.getCaps();m.textureLOD?d._features.supportRenderAndCopyToLodForFloatTextures?m.textureHalfFloatRender&&m.textureHalfFloatLinearFiltering?(f=!0,e.type=2):m.textureFloatRender&&m.textureFloatLinearFiltering&&(f=!0,e.type=1):f=!1:(f=!1,c=a);let w=0;if(f)d.isWebGPU?(w=1,await r.e("7908").then(r.bind(r,50850))):await r.e("354").then(r.bind(r,97525)),g=new p.D("rgbdDecode","rgbdDecode",null,null,1,null,3,d,!1,void 0,e.type,void 0,null,!1,void 0,w),e._isRGBD=!1,e.invertY=!1,x=d.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,c){h={};let t=e._lodGenerationScale,r=e._lodGenerationOffset;for(let n=0;n<3;n++){let a=(u-1)*t+r,i=Math.round(Math.min(Math.max(r+(a-r)*(1-n/2),0),a)),l=new o.l(d,2);l.isCube=!0,l.invertY=!0,l.generateMipMaps=!1,d.updateTextureSamplingMode(2,l);let p=new s.V(null);switch(p._isCube=!0,p._texture=l,h[i]=p,n){case 0:e._lodTextureLow=p;break;case 1:e._lodTextureMid=p;break;case 2:e._lodTextureHigh=p}}}let T=[];for(let r=0;r<t.length;r++)for(let n=0;n<6;n++){let a,i=new Blob([t[r][n]],{type:l}),o=URL.createObjectURL(i);if(d._features.forceBitmapOverHTMLImageElement)a=d.createImageBitmap(i,{premultiplyAlpha:"none"}).then(t=>z(t,d,f,g,o,n,r,c,h,x,e));else{let t=new Image;t.src=o,a=new Promise((a,i)=>{t.onload=()=>{z(t,d,f,g,o,n,r,c,h,x,e).then(()=>a()).catch(e=>{i(e)})},t.onerror=e=>{i(e)}})}T.push(a)}if(await Promise.all(T),t.length<u){let r,n=Math.pow(2,u-1-t.length),a=n*n*4;switch(e.type){case 0:r=new Uint8Array(a);break;case 2:r=new Uint16Array(a);break;case 1:r=new Float32Array(a)}for(let n=t.length;n<u;n++)for(let t=0;t<6;t++)d._uploadArrayBufferViewToTexture(x?.texture||e,r,t,n)}if(x){let t=e._irradianceTexture;e._irradianceTexture=null,d._releaseTexture(e),x._swapAndDie(e),e._irradianceTexture=t}g&&g.dispose(),c&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function M(e,t){let r=(t=h(t)).irradiance;if(!r)return;let n=new l.i;a.P.FromArrayToRef(r.x,0,n.x),a.P.FromArrayToRef(r.y,0,n.y),a.P.FromArrayToRef(r.z,0,n.z),a.P.FromArrayToRef(r.xx,0,n.xx),a.P.FromArrayToRef(r.yy,0,n.yy),a.P.FromArrayToRef(r.zz,0,n.zz),a.P.FromArrayToRef(r.yz,0,n.yz),a.P.FromArrayToRef(r.zx,0,n.zx),a.P.FromArrayToRef(r.xy,0,n.xy),e._sphericalPolynomial=n}function D(e,t,r,n,a){let i=A(e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),t).then(()=>e);return e.onRebuildCallback=e=>({proxy:i,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=t,e._lodGenerationScale=n,e._lodGenerationOffset=a,e._sphericalPolynomial=r,A(e,t).then(()=>(e.isReady=!0,e))}let P={GetEnvInfo:x,CreateEnvTextureAsync:m,CreateRadianceImageDataArrayBufferViews:T,CreateIrradianceImageDataArrayBufferViews:b,UploadEnvLevelsAsync:_,UploadRadianceLevelsAsync:A,UploadIrradianceLevelsAsync:v,UploadEnvSpherical:M}}}]);